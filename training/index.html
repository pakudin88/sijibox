<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIJIBOX (Mode Pembelajaran)</title>
    <!-- Memuat Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Memuat Tone.js untuk audio -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.min.js"></script>
    <!-- Memuat SortableJS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.2/Sortable.min.js"></script>
    
    <style>
        /* Menggunakan font Inter */
        html {
            height: 100%;
        }
        body {
            height: 100%;
            overflow-x: hidden;
            -webkit-touch-callout: none; /* iOS Safari */
            -webkit-user-select: none; /* Safari */
            -khtml-user-select: none; /* Konqueror HTML */
            -moz-user-select: none; /* Old Firefox */
            -ms-user-select: none; /* Internet Explorer/Edge */
            user-select: none; /* Non-prefixed version, currently supported by Chrome, Edge, Opera and Firefox */
            
            font-family: 'Inter', sans-serif;
            
            /* BARU: Latar belakang gradien BERGERAK */
            background: linear-gradient(-45deg, #e0e7ff, #f3f4f6, #c7d2fe, #e0e7ff);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;

            display: flex;
            flex-direction: column; 
            align-items: center;
            justify-content: center;
            padding: 1rem; /* sm:p-4; */
            min-height: 100%;
        }

        /* BARU: Animasi Gradien Latar Belakang */
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* Area Labirin Responsif */
        #maze-grid {
            display: grid;
            /* BARU: Latar belakang grid dibuat lebih gelap untuk kontras */
            background-color: #f3f4f6; /* gray-100 */
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            overflow: hidden;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
            grid-template-columns: repeat(var(--maze-cols, 5), minmax(0, 1fr));
            grid-template-rows: repeat(var(--maze-rows, 5), minmax(0, 1fr));
            width: 100%;
            aspect-ratio: 1 / 1;
        }
        
        /* Petak */
        .grid-tile {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: clamp(1.25rem, 6vw, 2rem);
            line-height: 1;
            /* BARU: Transisi halus saat petak berubah */
            transition: background-color 0.3s ease;
        }
        
        /* BARU: Dinding dengan gradien */
        .wall { 
            background-color: #4b5563; /* gray-600 */
            background-image: linear-gradient(to top right, #4b5563, #374151); /* gray-600 to gray-700 */
        }
        .path { background-color: #ffffff; }
        .finish { 
            background-color: #22c55e; /* green-500 */
            background-image: linear-gradient(to top right, #22c55e, #16a34a); /* green-500 to green-600 */
        }
        
        /* Pemain */
        #player {
            position: absolute;
            /* Ukuran disesuaikan di JS (PLAYER_SIZE) */
            width: var(--player-size, 32px); 
            height: var(--player-size, 32px);
            font-size: calc(var(--player-size, 32px) * 0.6); /* Ukuran emoji dinamis */
            
            /* BARU: Tampilan "Bot" */
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #3b82f6; /* blue-500 */
            border: 2px solid #dbeafe; /* blue-100 */
            border-radius: 9999px; /* rounded-full */
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.5); /* Shadow biru */
            
            transition: all 0.2s ease-in-out;
            transform-origin: center center;
            z-index: 10;
        }
        #player-emoji {
             /* Emoji tidak bisa di-rotate, jadi kita rotate parent-nya (#player) */
             line-height: 1;
        }
        
        /* === Gaya Drag-and-Drop === */
        
        /* Blok Perintah (Umum) */
        .cmd-block {
            position: relative;
            padding: 0.75rem; /* p-3 */
            border-radius: 0.75rem; /* rounded-xl */
            color: white;
            font-weight: 600; /* font-semibold */
            /* BARU: Bayangan lebih dalam dan 3D */
            box-shadow: 0 1px 2px rgba(0,0,0,0.1), 
                        0 4px 8px rgba(0,0,0,0.1), 
                        inset 0 1px 1px rgba(255,255,255,0.2);
            cursor: grab;
            transition: all 0.15s ease-out;
            /* BARU: Border bawah untuk efek 3D */
            border-bottom: 3px solid rgba(0,0,0,0.2);
        }
        .cmd-block:active { 
            cursor: grabbing; 
            transform: scale(0.95);
            box-shadow: inset 0 2px 4px 0 rgba(0,0,0,0.1);
            border-bottom-width: 1px; /* Efek tertekan */
        }

        /* Blok di Palette */
        #palette-controls .cmd-block {
            transition: transform 0.1s ease-out;
        }
        #palette-controls .cmd-block:hover {
            transform: scale(1.05); /* Efek "pop" lebih besar */
        }

        /* Blok di Area Program */
        #program-container {
            min-height: 150px;
            background-color: rgba(255, 255, 255, 0.7); /* Sedikit transparan */
            border: 2px dashed #d1d5db; /* border-dashed border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.75rem; /* p-3 */
            overflow-y: auto;
            min-height: 150px;
            max-height: 24rem; /* max-h-96 */
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* space-y-2 */
        }
        
        /* Blok Kontainer (Ulangi, Jika) di Area Program */
        .cmd-block.is-container {
            padding-bottom: 0.5rem;
        }
        
        /* Area Drop internal untuk blok kontainer */
        .cmd-block-content {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 0.5rem; /* rounded-lg */
            padding: 0.5rem; /* p-2 */
            margin-top: 0.5rem; /* mt-2 */
            min-height: 40px;
            display: flex;
            flex-direction: column;
            gap: 0.5rem; /* space-y-2 */
            /* BARU: Efek inset halus */
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
        }

        /* BARU: Warna Blok Gradien */
        .bg-cmd-forward { 
            background-image: linear-gradient(to top right, #22c55e, #16a34a); /* green-500 to green-600 */
            border-bottom-color: #15803d; /* green-700 */
        }
        .bg-cmd-left, .bg-cmd-right { 
            background-image: linear-gradient(to top right, #3b82f6, #2563eb); /* blue-500 to blue-600 */
            border-bottom-color: #1d4ed8; /* blue-700 */
        }
        .bg-cmd-repeat { 
            background-image: linear-gradient(to top right, #eab308, #d97706); /* yellow-500 to amber-600 */
            border-bottom-color: #b45309; /* amber-700 */
        }
        .bg-cmd-repeat_forever { 
            background-image: linear-gradient(to top right, #f59e0b, #ea580c); /* amber-500 to orange-600 */
            border-bottom-color: #c2410c; /* orange-700 */
        }
        .bg-cmd-if, .bg-cmd-if_else { 
            background-image: linear-gradient(to top right, #8b5cf6, #7c3aed); /* purple-500 to purple-600 */
            border-bottom-color: #6d28d9; /* purple-700 */
        }
        .bg-cmd-if_else { 
            background-image: linear-gradient(to top right, #a855f7, #9333ea); /* purple-500 to purple-600 */
            border-bottom-color: #7e22ce; /* purple-700 */
        }
        .bg-pink-500 { 
            background-image: linear-gradient(to top right, #ec4899, #d946ef); /* pink-500 to fuchsia-500 */
            border-bottom-color: #c026d3; /* fuchsia-600 */
        }
        .bg-pink-400 { 
            background-image: linear-gradient(to top right, #f472b6, #e879f9); /* pink-400 to fuchsia-400 */
            border-bottom-color: #d946ef; /* fuchsia-500 */
        }

        /* Tombol Hapus Internal */
        .btn-delete-cmd {
            position: absolute;
            top: -0.5rem; /* -top-2 */
            right: -0.5rem; /* -right-2 */
            padding: 0.375rem; /* p-1.5 */
            font-size: 0.75rem; /* text-xs */
            line-height: 1;
            font-weight: bold;
            color: #ef4444; /* red-500 */
            background-color: #fee2e2; /* red-100 */
            border: 2px solid #ef4444; /* red-500 */
            border-radius: 9999px; /* rounded-full */
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .btn-delete-cmd:hover {
            background-color: #ef4444; /* red-500 */
            color: #ffffff; /* white */
            transform: scale(1.1);
        }

        /* CSS untuk 'ghost' (saat di-drag) */
        .sortable-ghost {
            opacity: 0.4;
            background: #9ca3af;
            border-radius: 0.75rem; 
        }
        
        /* CSS untuk 'clone' (yang ditarik dari palette) */
        .sortable-clone {
            opacity: 0.8;
            transform: rotate(2deg);
        }

        /* Sorotan Eksekusi */
        .executing {
            animation: pulse-animation 0.5s infinite alternate;
        }
        /* BARU: Animasi sorot yang lebih cepat dan jelas */
        @keyframes pulse-animation {
            from { 
                transform: scale(1.05);
                box-shadow: 0 0 0 5px rgba(59, 130, 246, 0.7); 
            }
            to { 
                transform: scale(1.0);
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }
    </style>
</head>
<body class="min-h-screen">
    
    <!-- Kontainer Utama Aplikasi -->
    <div class="bg-white/95 backdrop-blur-sm rounded-2xl shadow-xl sm:shadow-2xl p-4 sm:p-6 md:p-8 w-full max-w-5xl mx-auto">
        
        <!-- BARU: Judul Gradien -->
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600 mb-1">SIJIBOX</h1>
        <p class="text-lg text-center text-gray-600 mb-6 font-medium">SIJI (Simulasi Interaktif Jejak Instruksi) BOX</p>
        
        <!-- Konten Utama (Layout Responsif) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            
            <!-- Kolom Kiri: Labirin dan Kontrol -->
            <div class="flex flex-col items-center">
                
                <h2 id="level-title" class="text-xl sm:text-2xl font-semibold text-indigo-600 mb-2">Level 1</h2>
                
                <div class="mb-4">
                    <label for="level-select" class="text-sm font-medium text-gray-700 mr-2">Pilih Level:</label>
                    <select id="level-select" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-2 focus:ring-indigo-500 text-base py-2 px-3 cursor-pointer">
                        <!-- Opsi akan ditambahkan oleh JS -->
                    </select>
                </div>

                <!-- Area Labirin (Relatif untuk Pemain) -->
                <div class="relative mb-4 w-full max-w-xs sm:max-w-sm">
                    <div id="maze-grid">
                        <!-- Petak labirin akan di-generate oleh JS di sini -->
                    </div>
                    <!-- BARU: Player diubah, emoji di dalam -->
                    <div id="player">
                        <span id="player-emoji">➡️</span>
                    </div>
                </div>
                
                <!-- Kontrol Eksekusi (Jalankan, Reset) -->
                <div id="execution-controls" class="flex space-x-4 mb-4">
                    <button id="btn-run" class="px-6 sm:px-8 py-3 bg-indigo-600 text-white font-semibold rounded-xl shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-opacity-50 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50">Jalankan!</button>
                    <button id="btn-reset" class="px-6 sm:px-8 py-3 bg-red-600 text-white font-semibold rounded-xl shadow-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition-all transform hover:scale-105 active:scale-95">Reset</button>
                </div>
                
                <!-- Kontrol Level (Level Berikutnya) -->
                <div id="level-controls" class="hidden text-center mb-4">
                    <button id="btn-next-level" class="px-8 py-3 bg-green-600 text-white font-semibold rounded-xl shadow-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 transition-all transform hover:scale-105 active:scale-95">Level Berikutnya</button>
                </div>

                <p id="status-message" class="text-lg sm:text-xl font-medium h-8">&nbsp;</p>
            </div>
            
            <!-- Kolom Kanan: Editor Program -->
            <div class="bg-gray-50/70 p-4 sm:p-6 rounded-2xl shadow-inner">
                
                <h3 class="text-lg font-semibold text-gray-900 mb-2">Palette Perintah:</h3>
                <div id="palette-controls" class="grid grid-cols-3 gap-3 sm:gap-4 mb-4">
                    <!-- Blok akan di-generate oleh JS -->
                </div>

                <h2 class="text-xl sm:text-2xl font-semibold text-gray-900 mb-2">Program:</h2>
                
                <div id="program-container" class="md:max-h-[60vh] sm:min-h-[200px]">
                    <!-- Perintah akan dirender oleh JS di sini -->
                </div>

            </div> <!-- Akhir Kolom Kanan -->
            
        </div> <!-- Akhir Layout 2 Kolom -->
        
        <!-- Copyright dipindah ke dalam card -->
        <div class="mt-6 pt-4 border-t border-gray-200">
            <p class="text-center text-sm text-gray-400 transition-all duration-300 hover:text-gray-600 cursor-default">
                FOOTAGE : copyright @ akhmad samsudin guru TIK SMP Negeri 1 Pasuruan
            </p>
        </div>

    </div> <!-- Akhir Kontainer Utama -->

    <script>
    window.addEventListener('load', () => {

        // --- Polyfill untuk crypto.randomUUID ---
        function generateUUID() {
            if (crypto && crypto.randomUUID) {
                return crypto.randomUUID();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        
        // --- Definisi Blok Global ---
        const BLOCK_DEFINITIONS = {
            'forward': {
                html: `<div class="cmd-block bg-cmd-forward" data-block-data='{"type":"forward", "id":"new"}'>⬆️ Maju</div>`,
                colSpan: 'col-span-1'
            },
            'left': {
                html: `<div class="cmd-block bg-cmd-left" data-block-data='{"type":"left", "id":"new"}'>↪️ Kiri</div>`,
                colSpan: 'col-span-1'
            },
            'right': {
                html: `<div class="cmd-block bg-cmd-right" data-block-data='{"type":"right", "id":"new"}'>↩️ Kanan</div>`,
                colSpan: 'col-span-1'
            },
            'repeat': {
                html: `<div class="cmd-block bg-cmd-repeat" data-block-data='{"type":"repeat", "times":3, "commands":[], "id":"new"}'>Ulangi 3x</div>`,
                colSpan: 'col-span-1'
            },
            'repeat_forever': {
                html: `<div class="cmd-block bg-cmd-repeat_forever" data-block-data='{"type":"repeat_forever", "commands":[], "id":"new"}'>Ulangi Terus</div>`,
                colSpan: 'col-span-2'
            },
            'if': {
                html: `<div class="cmd-block bg-cmd-if" data-block-data='{"type":"if", "condition":"path_ahead", "commands":[], "id":"new"}'>Jika Jalan</div>`,
                colSpan: 'col-span-1'
            },
            'if_else': {
                html: `<div class="cmd-block bg-cmd-if_else" data-block-data='{"type":"if_else", "condition":"path_ahead", "commands":[], "elseCommands":[], "id":"new"}'>Jika/Lainnya</div>`,
                colSpan: 'col-span-2'
            },
            'proc_def_1': {
                html: `<div class="cmd-block bg-pink-500" data-block-data='{"type":"proc_def_1", "name":"Fungsi 1", "commands":[], "id":"new"}'>Definisi Fungsi 1</div>`,
                colSpan: 'col-span-3'
            },
            'proc_call_1': {
                html: `<div class="cmd-block bg-pink-400" data-block-data='{"type":"proc_call_1", "name":"Fungsi 1", "id":"new"}'>Jalankan Fungsi 1</div>`,
                colSpan: 'col-span-3'
            }
        };

        // --- Definisi Level ---
        const LEVELS = [
            // Level 1: Jalur Lurus
            {
                maze: [
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 2], 
                    [1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1],
                    [1, 1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 }, 
                allowedBlocks: ['forward'] 
            },
            // Level 2: Belokan Sederhana
            {
                maze: [
                    [1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 1],
                    [1, 0, 1, 0, 1],
                    [1, 0, 1, 2, 1],
                    [1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right']
            },
            // Level 3: 'Ulangi 3x' (Tangga)
            {
                maze: [
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 1, 1, 1],
                    [1, 0, 0, 1, 1, 1],
                    [1, 1, 0, 0, 1, 1],
                    [1, 1, 1, 0, 0, 1], 
                    [1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat']
            },
            // Level 4: 'Ulangi Terus' + 'Jika/Lainnya'
            {
                maze: [
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 0, 1],
                    [1, 0, 1, 1, 0, 1],
                    [1, 0, 0, 0, 0, 1],
                    [1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'if_else', 'repeat_forever']
            },
            // Level 5: 'Ulangi Terus' + 'Jika'
            {
                maze: [
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 0, 1],
                    [1, 0, 0, 1, 0, 1],
                    [1, 1, 0, 0, 0, 1],
                    [1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'if', 'repeat_forever']
            },
            // Level 6: Spiral
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 1, 0, 1],
                    [1, 0, 1, 2, 1, 0, 1], 
                    [1, 0, 1, 0, 0, 0, 1],
                    [1, 0, 0, 0, 1, 0, 1], 
                    [1, 1, 1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'if', 'repeat_forever']
            },
            // Level 7: Labirin 'Tangan Kanan'
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 0, 0, 0, 1],
                    [1, 0, 1, 0, 1, 1, 1],
                    [1, 0, 0, 0, 1, 0, 1], 
                    [1, 1, 1, 0, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 1], 
                    [1, 1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'if', 'if_else', 'repeat_forever']
            },
            // Level 8: Kombinasi
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 1, 0, 0, 1],
                    [1, 0, 1, 0, 1, 0, 1, 1],
                    [1, 0, 1, 0, 0, 0, 0, 1],
                    [1, 1, 1, 0, 1, 1, 0, 1],
                    [1, 0, 0, 0, 1, 0, 0, 1],
                    [1, 0, 1, 1, 1, 0, 1, 1],
                    [1, 2, 0, 0, 0, 0, 0, 1]
                ],
                start: { x: 1, y: 1, dir: 2 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat', 'repeat_forever', 'if', 'if_else']
            },
            // Level 9: Pengenalan Fungsi
            {
                maze: [ 
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 1, 1, 1],
                    [1, 1, 0, 1, 1, 1],
                    [1, 1, 0, 0, 1, 1],
                    [1, 1, 1, 0, 1, 1],
                    [1, 1, 1, 2, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'proc_def_1', 'proc_call_1']
            },
            // Level 10: Fungsi + Ulangi
            {
                maze: [ 
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 1, 1, 1],
                    [1, 0, 0, 1, 1, 1],
                    [1, 1, 0, 0, 1, 1],
                    [1, 1, 1, 0, 0, 1],
                    [1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat', 'proc_def_1', 'proc_call_1'] 
            },
            // Level 11: Fungsi + Ulangi Zigzag
            {
                maze: [ 
                    [1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 1, 1, 1],
                    [1, 0, 0, 1, 1, 1],
                    [1, 1, 0, 0, 1, 1],
                    [1, 1, 1, 0, 0, 1],
                    [1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 2 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat', 'proc_def_1', 'proc_call_1'] 
            },
            // Level 12: Fungsi Pola Berulang
            {
                maze: [ 
                    [1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 1, 1, 1, 1],
                    [1, 1, 1, 0, 1, 1, 1, 1],
                    [1, 1, 1, 0, 0, 0, 1, 1],
                    [1, 1, 1, 1, 1, 0, 1, 1],
                    [1, 1, 1, 1, 1, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 2, 1],
                    [1, 1, 1, 1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat', 'proc_def_1', 'proc_call_1']
            },
            // Level 13: Fungsi + Kondisional "Cek Ruangan"
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 0, 1, 0, 1], 
                    [1, 0, 1, 0, 1, 0, 1], 
                    [1, 0, 1, 0, 1, 2, 1], 
                    [1, 0, 0, 0, 0, 0, 1], 
                    [1, 1, 1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 4, dir: 1 }, 
                allowedBlocks: ['forward', 'left', 'right', 'repeat_forever', 'if', 'proc_def_1', 'proc_call_1']
            },
            // Level 14: Fungsi "Langkah Cerdas"
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 1, 0, 1],
                    [1, 0, 1, 0, 0, 0, 1],
                    [1, 0, 1, 0, 1, 1, 1],
                    [1, 0, 0, 0, 0, 2, 1],
                    [1, 1, 1, 1, 1, 1, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat_forever', 'if_else', 'proc_def_1', 'proc_call_1']
            },
            // Level 15: Labirin Final
            {
                maze: [
                    [1, 1, 1, 1, 1, 1, 1, 1, 1],
                    [1, 0, 1, 0, 0, 0, 1, 0, 1],
                    [1, 0, 1, 0, 1, 0, 1, 0, 1],
                    [1, 0, 0, 0, 1, 0, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 1, 0, 1],
                    [1, 0, 0, 0, 0, 0, 0, 0, 1],
                    [1, 0, 1, 1, 1, 1, 1, 0, 1], 
                    [1, 0, 1, 0, 0, 0, 0, 0, 1],
                    [1, 1, 1, 1, 1, 1, 1, 2, 1]
                ],
                start: { x: 1, y: 1, dir: 1 },
                allowedBlocks: ['forward', 'left', 'right', 'repeat', 'repeat_forever', 'if', 'if_else', 'proc_def_1', 'proc_call_1']
            }
        ];

        // --- State Game ---
        let currentLevel = 0;
        let MAZE = [];
        let player = { x: 0, y: 0, dir: 0 };
        let startPos = { x: 0, y: 0, dir: 0 };
        let program = { commands: [] }; 
        let isRunning = false;
        let executionAbort = false;
        let executionInterval = null;
        let paletteSortable = null; 
        
        // --- BARU: Ukuran Bot ---
        let PLAYER_SIZE = 32; 

        // --- Referensi DOM ---
        const mazeGrid = document.getElementById('maze-grid');
        const playerEl = document.getElementById('player');
        const playerEmojiEl = document.getElementById('player-emoji'); // BARU
        const levelTitle = document.getElementById('level-title');
        const levelSelect = document.getElementById('level-select');
        const programContainer = document.getElementById('program-container');
        const paletteControls = document.getElementById('palette-controls');
        const btnRun = document.getElementById('btn-run');
        const btnReset = document.getElementById('btn-reset');
        const btnNextLevel = document.getElementById('btn-next-level');
        const executionControls = document.getElementById('execution-controls');
        const levelControls = document.getElementById('level-controls');
        
        // --- Setup Efek Suara ---
        let moveSound, turnSound, wallSound, winSound, failSound;
        let soundsReady = false;

        function initSounds() {
            if (soundsReady || !window.Tone) return;
            try {
                moveSound = new Tone.Synth({ oscillator: { type: 'sine' }, envelope: { attack: 0.01, decay: 0.1, sustain: 0, release: 0.1 } }).toDestination();
                turnSound = new Tone.NoiseSynth({ noise: { type: 'white' }, envelope: { attack: 0.01, decay: 0.05, sustain: 0, release: 0.05 } }).toDestination();
                wallSound = new Tone.MembraneSynth({ pitchDecay: 0.1, octaves: 2, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
                winSound = new Tone.PolySynth(Tone.Synth, { envelope: { attack: 0.01, decay: 0.1, sustain: 0.1, release: 0.2 } }).toDestination();
                failSound = new Tone.Synth({ oscillator: { type: 'triangle' }, envelope: { attack: 0.01, decay: 0.2, sustain: 0, release: 0.1 } }).toDestination();
                console.log("Tone.js berhasil diinisialisasi.");
                soundsReady = true;
            } catch (e) {
                console.error("Gagal inisialisasi Tone.js:", e);
                soundsReady = false;
            }
        }

        // --- Fungsi Helper ---
        function findCommandByType(commandList, type) {
            for (const cmd of commandList) {
                if (cmd.type === type) return cmd;
            }
            return null;
        }
        
        function populatePalette(allowedBlocks) {
            if (paletteSortable) paletteSortable.destroy();
            paletteControls.innerHTML = '';
            
            allowedBlocks.forEach(blockType => {
                const blockDef = BLOCK_DEFINITIONS[blockType];
                if (blockDef) {
                    const el = document.createElement('div');
                    el.className = blockDef.colSpan;
                    el.innerHTML = blockDef.html;
                    paletteControls.appendChild(el.firstElementChild);
                }
            });

            paletteSortable = new Sortable(paletteControls, {
                group: { name: 'commands', pull: 'clone', put: false },
                animation: 150,
                sort: false,
                onClone: (evt) => { initSounds(); }
            });
        }

        // --- Fungsi Render dan UI ---
        function renderProgram(container, commandList) {
            container.innerHTML = ''; 
            commandList.forEach(cmd => {
                const el = createBlockElement(cmd);
                container.appendChild(el);
                
                if (cmd.type === 'repeat' || cmd.type === 'repeat_forever' || cmd.type === 'proc_def_1') { 
                    const contentEl = el.querySelector('.cmd-block-content');
                    if (contentEl) renderProgram(contentEl, cmd.commands);
                } else if (cmd.type === 'if') {
                    const contentEl = el.querySelector('.cmd-block-content');
                    renderProgram(contentEl, cmd.commands);
                } else if (cmd.type === 'if_else') {
                    const ifContentEl = el.querySelector('.cmd-block-content[data-type="if"]');
                    const elseContentEl = el.querySelector('.cmd-block-content[data-type="else"]');
                    renderProgram(ifContentEl, cmd.commands);
                    renderProgram(elseContentEl, cmd.elseCommands);
                }
            });
            initSortable(container, commandList);
        }

        function createBlockElement(cmd) {
            const el = document.createElement('div');
            el.className = 'cmd-block';
            el.dataset.id = cmd.id;
            let contentHTML = `<button class="btn-delete-cmd" title="Hapus">✖</button>`;

            if (cmd.type === 'forward') {
                el.classList.add('bg-cmd-forward');
                contentHTML += '⬆️ Maju';
            } else if (cmd.type === 'left') {
                el.classList.add('bg-cmd-left');
                contentHTML += '↪️ Kiri';
            } else if (cmd.type === 'right') {
                el.classList.add('bg-cmd-right');
                contentHTML += '↩️ Kanan';
            } else {
                el.classList.add('is-container');
                if (cmd.type === 'repeat') {
                    el.classList.add('bg-cmd-repeat');
                    contentHTML += `Ulangi ${cmd.times}x:`;
                    contentHTML += `<div class="cmd-block-content" data-id="${cmd.id}-content"></div>`;
                } else if (cmd.type === 'repeat_forever') {
                    el.classList.add('bg-cmd-repeat_forever');
                    contentHTML += `Ulangi Terus Menerus:`;
                    contentHTML += `<div class="cmd-block-content" data-id="${cmd.id}-content"></div>`;
                } else if (cmd.type === 'if') {
                    el.classList.add('bg-cmd-if');
                    contentHTML += `Jika ${createConditionDropdown(cmd)}:`;
                    contentHTML += `<div class="cmd-block-content" data-id="${cmd.id}-content"></div>`;
                } else if (cmd.type === 'if_else') {
                    el.classList.add('bg-cmd-if_else');
                    contentHTML += `Jika ${createConditionDropdown(cmd)}:`;
                    contentHTML += `<div class="cmd-block-content" data-type="if" data-id="${cmd.id}-content"></div>`;
                    contentHTML += `<div class="mt-2 pt-2 border-t border-white/30">Lainnya:</div>`;
                    contentHTML += `<div class="cmd-block-content" data-type="else" data-id="${cmd.id}-else-content"></div>`;
                } else if (cmd.type === 'proc_def_1') {
                    el.classList.add('is-container');
                    el.classList.add('bg-pink-500');
                    contentHTML += `Definisi ${cmd.name}:`;
                    contentHTML += `<div class="cmd-block-content" data-id="${cmd.id}-content"></div>`;
                } else if (cmd.type === 'proc_call_1') {
                    el.classList.add('bg-pink-400');
                    contentHTML += `Jalankan ${cmd.name}`;
                }
            }
            el.innerHTML = contentHTML;
            return el;
        }
        
        function createConditionDropdown(cmd) {
            const stopPropagation = `event.stopPropagation();`;
            return `
                <select class="condition-select bg-white/20 rounded ml-1 text-black" 
                        data-id="${cmd.id}" 
                        onmousedown="${stopPropagation}" 
                        ontouchstart="${stopPropagation}">
                    <option value="path_ahead" ${cmd.condition === 'path_ahead' ? 'selected' : ''}>Jalan di Depan</option>
                    <option value="path_left" ${cmd.condition === 'path_left' ? 'selected' : ''}>Jalan di Kiri</option>
                    <option value="path_right" ${cmd.condition === 'path_right' ? 'selected' : ''}>Jalan di Kanan</option>
                </select>
            `;
        }
        
        // --- Logika SortableJS (Drag & Drop) ---
        let sortableInstances = [];

        function destroySortables() {
            sortableInstances.forEach(s => s.destroy());
            sortableInstances = [];
        }

        function initSortable(container, commandList) {
            const instance = new Sortable(container, {
                group: 'commands',
                animation: 150,
                ghostClass: 'sortable-ghost',
                onAdd: (evt) => {
                    const el = evt.item;
                    const blockDataJSON = el.dataset.blockData;
                    if (!blockDataJSON) {
                        const cmdId = el.dataset.id;
                        const blockData = findAndRemoveCommand(program.commands, cmdId);
                        if (blockData) {
                            commandList.splice(evt.newIndex, 0, blockData);
                        }
                    } else {
                        const newBlockData = JSON.parse(blockDataJSON);
                        newBlockData.id = generateUUID();
                        const newEl = createBlockElement(newBlockData);
                        el.parentNode.replaceChild(newEl, el);
                        commandList.splice(evt.newIndex, 0, newBlockData);
                    }
                    fullRerenderAndReinit();
                },
                onUpdate: (evt) => {
                    const item = commandList.splice(evt.oldIndex, 1)[0];
                    commandList.splice(evt.newIndex, 0, item);
                    fullRerenderAndReinit();
                },
                onRemove: (evt) => {
                    if (evt.item.parentNode) {
                        findAndRemoveCommand(commandList, evt.item.dataset.id);
                    }
                    fullRerenderAndReinit();
                }
            });
            sortableInstances.push(instance);
        }

        function findAndRemoveCommand(commandList, id) {
            for (let i = 0; i < commandList.length; i++) {
                const cmd = commandList[i];
                if (cmd.id === id) {
                    return commandList.splice(i, 1)[0];
                }
                if (cmd.commands) {
                    const found = findAndRemoveCommand(cmd.commands, id);
                    if (found) return found;
                }
                if (cmd.elseCommands) {
                    const found = findAndRemoveCommand(cmd.elseCommands, id);
                    if (found) return found;
                }
                if (cmd.type === 'proc_def_1' && cmd.commands) {
                     const found = findAndRemoveCommand(cmd.commands, id);
                    if (found) return found;
                }
            }
            return null;
        }
        
        function fullRerenderAndReinit() {
            destroySortables();
            renderProgram(programContainer, program.commands);
        }

        // --- Event Handlers (Klik) ---
        programContainer.addEventListener('click', (e) => {
            if (isRunning) return;
            const deleteBtn = e.target.closest('.btn-delete-cmd');
            if (deleteBtn) {
                e.stopPropagation();
                const blockEl = e.target.closest('.cmd-block');
                const cmdId = blockEl.dataset.id;
                findAndRemoveCommand(program.commands, cmdId);
                fullRerenderAndReinit();
            }
        });
        
        programContainer.addEventListener('change', (e) => {
             if (isRunning) return;
            const select = e.target.closest('.condition-select');
            if (select) {
                const cmdId = select.dataset.id;
                const newCondition = select.value;
                function findAndUpdate(commandList, id, newCond) {
                    for (const cmd of commandList) {
                        if (cmd.id === id) {
                            cmd.condition = newCond;
                            return true;
                        }
                        if (cmd.commands && findAndUpdate(cmd.commands, id, newCond)) return true;
                        if (cmd.elseCommands && findAndUpdate(cmd.elseCommands, id, newCond)) return true;
                    }
                    return false;
                }
                findAndUpdate(program.commands, cmdId, newCondition);
                fullRerenderAndReinit();
            }
        });

        // --- Logika Inti Game ---
        function drawMaze() {
            const levelData = LEVELS[currentLevel];
            MAZE = levelData.maze;
            const rows = MAZE.length;
            const cols = MAZE[0].length;
            
            mazeGrid.style.setProperty('--maze-rows', rows);
            mazeGrid.style.setProperty('--maze-cols', cols);
            mazeGrid.innerHTML = ''; 

            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const tile = document.createElement('div');
                    tile.className = 'grid-tile';
                    if (MAZE[y][x] === 1) tile.classList.add('wall');
                    else if (MAZE[y][x] === 2) tile.classList.add('finish');
                    else tile.classList.add('path');
                    mazeGrid.appendChild(tile);
                }
            }
            // Tunda pembaruan posisi pemain sedikit untuk memastikan grid sudah digambar
            setTimeout(updatePlayerPosition, 0);
        }

        function updatePlayerPosition() {
            const gridRect = mazeGrid.getBoundingClientRect();
            if (gridRect.width === 0) return;
            
            const { x, y, dir } = player;
            const gridWidth = gridRect.width;
            const cols = MAZE[0].length;
            const TILE_SIZE = gridWidth / cols;

            // BARU: Sesuaikan ukuran bot berdasarkan ukuran petak
            PLAYER_SIZE = Math.max(16, Math.min(32, TILE_SIZE * 0.7)); 
            playerEl.style.setProperty('--player-size', `${PLAYER_SIZE}px`);

            const PLAYER_OFFSET = (TILE_SIZE - PLAYER_SIZE) / 2;

            playerEl.style.left = `${x * TILE_SIZE + PLAYER_OFFSET}px`;
            playerEl.style.top = `${y * TILE_SIZE + PLAYER_OFFSET}px`;
            
            // BARU: Rotasi #player, bukan emoji
            if (dir === 0) playerEl.style.transform = 'rotate(-90deg)';
            if (dir === 1) playerEl.style.transform = 'rotate(0deg)';
            if (dir === 2) playerEl.style.transform = 'rotate(90deg)';
            if (dir === 3) playerEl.style.transform = 'rotate(180deg)';
        }

        function loadLevel(levelIndex) {
            currentLevel = levelIndex;
            if (currentLevel >= LEVELS.length) {
                showMessage("Anda telah menyelesaikan semua level!", true);
                executionControls.classList.add('hidden');
                levelControls.classList.add('hidden');
                levelTitle.textContent = "Tamat!";
                levelSelect.classList.add('hidden');
                return;
            }
            
            levelTitle.textContent = `Level ${currentLevel + 1}`;
            levelSelect.value = currentLevel;
            levelSelect.classList.remove('hidden');
            
            const levelData = LEVELS[currentLevel];
            startPos = { ...levelData.start };
            player = { ...startPos };
            
            populatePalette(levelData.allowedBlocks);
            drawMaze();
            resetGame();
        }

        function resetGame() {
            player = { ...startPos };
            updatePlayerPosition();
            
            executionAbort = true;
            if (executionInterval) clearInterval(executionInterval);
            executionInterval = null;
            isRunning = false;
            program.commands = [];
            
            executionControls.classList.remove('hidden');
            levelControls.classList.add('hidden');
            disableInput(false);
            
            document.querySelectorAll('.executing').forEach(el => el.classList.remove('executing'));
            showMessage("&nbsp;");
            fullRerenderAndReinit();
        }
        
        function disableInput(disabled) {
             btnRun.disabled = disabled;
             btnReset.disabled = disabled;
             levelSelect.disabled = disabled;
             btnRun.textContent = disabled ? 'Menjalankan...' : 'Jalankan!';
             sortableInstances.forEach(s => s.option('disabled', disabled));
             if(paletteSortable) paletteSortable.option('disabled', disabled);
             programContainer.querySelectorAll('.btn-delete-cmd, .condition-select').forEach(el => {
                 el.disabled = disabled;
             });
        }

        function showMessage(text, isSuccess) {
            const statusEl = document.getElementById('status-message');
            statusEl.innerHTML = text;
            statusEl.className = 'text-lg sm:text-xl font-medium h-8 '; // Reset
            if (isSuccess === true) statusEl.classList.add('text-green-600');
            else if (isSuccess === false) statusEl.classList.add('text-red-600');
            else statusEl.classList.add('text-gray-700');
        }
        
        const sleep = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        function checkCondition(condition) {
            let { x, y, dir } = player;
            let checkDir = dir;
            if (condition === 'path_left') checkDir = (dir - 1 + 4) % 4;
            else if (condition === 'path_right') checkDir = (dir + 1) % 4;
            if (checkDir === 0) y--;
            if (checkDir === 1) x++;
            if (checkDir === 2) y++;
            if (checkDir === 3) x--;
            return MAZE[y] !== undefined && MAZE[y][x] !== undefined && MAZE[y][x] !== 1;
        }

        function highlightCommand(cmdId) {
            document.querySelectorAll('.executing').forEach(el => el.classList.remove('executing'));
            const el = document.querySelector(`[data-id="${cmdId}"]`);
            if (el) {
                el.classList.add('executing');
                el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        // --- EKSEKUSI PROGRAM ---
        async function runProgram() {
            if (isRunning) return;
            initSounds(); 
            player = { ...startPos };
            updatePlayerPosition();
            isRunning = true;
            executionAbort = false;
            disableInput(true);
            showMessage("&nbsp;");

            try {
                await executeCommandList(program.commands);
                if (!executionAbort && MAZE[player.y][player.x] !== 2) {
                    throw new Error("Belum sampai di finish!");
                }
            } catch (error) {
                if (!executionAbort) {
                    showMessage(error.message, false);
                    if (soundsReady && failSound) failSound.triggerAttackRelease("C3", "0.2", Tone.now());
                }
            } finally {
                isRunning = false;
                disableInput(false);
                btnReset.disabled = false;
                document.querySelectorAll('.executing').forEach(el => el.classList.remove('executing'));

                if (!executionAbort && MAZE[player.y][player.x] === 2) {
                    showMessage("Berhasil!", true);
                    if (soundsReady && winSound) winSound.triggerAttackRelease(["C4", "E4", "G4"], "0.2", Tone.now());
                    executionControls.classList.add('hidden');
                    levelControls.classList.remove('hidden');
                }
            }
        }

        async function executeCommandList(commandList) {
            for (const cmd of commandList) {
                if (executionAbort) throw new Error("Eksekusi dihentikan.");
                if (cmd.type === 'proc_def_1') continue;

                highlightCommand(cmd.id);
                await sleep(300); // Kecepatan eksekusi

                if (cmd.type === 'forward') {
                    let { x, y, dir } = player;
                    if (dir === 0) y--;
                    if (dir === 1) x++;
                    if (dir === 2) y++;
                    if (dir === 3) x--;
                    
                    if (MAZE[y] === undefined || MAZE[y][x] === undefined || MAZE[y][x] === 1) {
                        if (soundsReady && wallSound) wallSound.triggerAttackRelease("C2", "0.2", Tone.now());
                        throw new Error("Menabrak! Coba lagi.");
                    }
                    
                    player.x = x;
                    player.y = y;
                    updatePlayerPosition();
                    if (soundsReady && moveSound) moveSound.triggerAttackRelease("C4", "0.1", Tone.now());
                    if (MAZE[y][x] === 2) return; 
                } 
                else if (cmd.type === 'left') {
                    player.dir = (player.dir - 1 + 4) % 4;
                    updatePlayerPosition();
                    if (soundsReady && turnSound) turnSound.triggerAttackRelease("0.05", Tone.now(), 0.1);
                } 
                else if (cmd.type === 'right') {
                    player.dir = (player.dir + 1) % 4;
                    updatePlayerPosition();
                    if (soundsReady && turnSound) turnSound.triggerAttackRelease("0.05", Tone.now(), 0.1);
                }
                else if (cmd.type === 'repeat') {
                    for (let i = 0; i < cmd.times; i++) {
                        await executeCommandList(cmd.commands);
                        if (executionAbort || MAZE[player.y][player.x] === 2) return;
                    }
                }
                else if (cmd.type === 'repeat_forever') {
                    let loopCount = 0;
                    while (loopCount < 200) { // Batas aman
                        await executeCommandList(cmd.commands);
                        if (executionAbort || MAZE[player.y][player.x] === 2) return;
                        await sleep(100);
                        loopCount++;
                    }
                    if(!executionAbort) throw new Error("Program terlalu panjang!");
                }
                else if (cmd.type === 'if') {
                    if (checkCondition(cmd.condition)) {
                        await executeCommandList(cmd.commands);
                        if (executionAbort || MAZE[player.y][player.x] === 2) return;
                    }
                }
                else if (cmd.type === 'if_else') {
                    if (checkCondition(cmd.condition)) {
                        await executeCommandList(cmd.commands);
                    } else {
                        await executeCommandList(cmd.elseCommands);
                    }
                    if (executionAbort || MAZE[player.y][player.x] === 2) return;
                }
                else if (cmd.type === 'proc_call_1') {
                    const funcDef = findCommandByType(program.commands, 'proc_def_1');
                    if (funcDef && funcDef.commands) {
                        await executeCommandList(funcDef.commands);
                        if (executionAbort || MAZE[player.y][player.x] === 2) return;
                    }
                }
                
                if (MAZE[player.y][player.x] !== 2) {
                   await sleep(200); // Jeda antar blok
                }
            }
        }

        // --- Event Listeners Global ---
        btnRun.addEventListener('click', runProgram);
        btnReset.addEventListener('click', () => {
            executionAbort = true;
            loadLevel(currentLevel);
        });
        btnNextLevel.addEventListener('click', () => {
            loadLevel(currentLevel + 1);
        });
        window.addEventListener('resize', updatePlayerPosition);

        function populateLevelSelect() {
            levelSelect.innerHTML = '';
            for (let i = 0; i < LEVELS.length; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `Level ${i + 1}`;
                levelSelect.appendChild(option);
            }
        }
        
        levelSelect.addEventListener('change', () => {
            const newLevelIndex = parseInt(levelSelect.value, 10);
            loadLevel(newLevelIndex);
        });

        // --- Inisialisasi Game ---
        populateLevelSelect();
        loadLevel(0); // Mulai dari Level 1
    });
    </script>
</body>
</html>
